<theme-toggle>
  <button
    id="theme-toggle"
    aria-label="Cambiar modo oscuro/claro"
    class="group relative flex h-8 w-8 items-center justify-center overflow-hidden rounded-full bg-transparent lg:ml-2"
    type="button"
  >
    <span id="theme-icon" class="relative flex h-6 w-6 items-center justify-center">
      <!-- Sol (visible en modo claro) -->
      <svg
        id="icon-sun"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        class="dark:text-muted absolute h-5 w-5 transform text-gray-700 transition-all duration-300 ease-in-out group-hover:text-teal-600 dark:group-hover:text-teal-400"
        style="opacity: 1; transform: rotate(0deg) scale(1);"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
      >
        <circle cx="12" cy="12" r="3"></circle>
        <path
          d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"
        ></path>
      </svg>

      <!-- Luna (visible en modo oscuro) -->
      <svg
        id="icon-moon"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        class="dark:text-muted absolute h-5 w-5 transform text-gray-700 transition-all duration-300 ease-in-out group-hover:text-teal-600 dark:group-hover:text-teal-400"
        style="opacity: 0; transform: rotate(180deg) scale(0.8);"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
      >
        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
      </svg>
    </span>
  </button>
</theme-toggle>

<script>
  (function () {
    // Definir el web component solo una vez
    if (typeof customElements !== "undefined" && !customElements.get("theme-toggle")) {
      class ThemeToggle extends HTMLElement {
        constructor() {
          super();

          var button = this.querySelector("button") as HTMLButtonElement | null;
          var iconSun = this.querySelector("#icon-sun") as HTMLElement | null;
          var iconMoon = this.querySelector("#icon-moon") as HTMLElement | null;

          function setTheme(dark: boolean) {
            // Actualizar el DOM inmediatamente
            if (dark) {
              document.documentElement.classList.add("dark");
            } else {
              document.documentElement.classList.remove("dark");
            }

            if (button) button.setAttribute("aria-pressed", String(dark));
            if (button)
              button.setAttribute(
                "aria-label",
                dark ? "Activar modo claro" : "Activar modo oscuro"
              );

            // Guardar preferencia en localStorage
            try {
              localStorage.setItem("theme", dark ? "dark" : "light");
            } catch (e) {}

            // Animaci칩n suave al cambiar iconos
            if (iconSun && iconMoon) {
              if (dark) {
                iconSun.style.opacity = "0";
                iconSun.style.transform = "rotate(-90deg) scale(0.8)";
                iconMoon.style.opacity = "1";
                iconMoon.style.transform = "rotate(0deg) scale(1)";
              } else {
                iconMoon.style.opacity = "0";
                iconMoon.style.transform = "rotate(90deg) scale(0.8)";
                iconSun.style.opacity = "1";
                iconSun.style.transform = "rotate(0deg) scale(1)";
              }
            }
          }

          function applyStoredTheme() {
            // Preferir la clase ya aplicada en <html> (Layout aplica el tema temprano)
            var isDark = document.documentElement.classList.contains("dark");

            // Si no est치 definida, fallback a localStorage/prefers-color-scheme
            if (!isDark) {
              var theme = null;
              try {
                theme = localStorage.getItem("theme");
              } catch (e) {}
              var prefersDark =
                window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
              isDark = theme === "dark" || (!theme && prefersDark);
            }

            if (button) button.setAttribute("aria-pressed", String(isDark));
            if (button)
              button.setAttribute(
                "aria-label",
                isDark ? "Activar modo claro" : "Activar modo oscuro"
              );

            if (iconSun && iconMoon) {
              if (isDark) {
                iconSun.style.opacity = "0";
                iconSun.style.transform = "rotate(-90deg) scale(0.8)";
                iconMoon.style.opacity = "1";
                iconMoon.style.transform = "rotate(0deg) scale(1)";
              } else {
                iconMoon.style.opacity = "0";
                iconMoon.style.transform = "rotate(90deg) scale(0.8)";
                iconSun.style.opacity = "1";
                iconSun.style.transform = "rotate(0deg) scale(1)";
              }
            }
          }

          // Click toggles
          if (button) {
            button.addEventListener("click", function () {
              var currentlyDark = document.documentElement.classList.contains("dark");
              setTheme(!currentlyDark);
            });
          }

          // Inicializar iconos con el tema actual del documento (sin retraso)
          applyStoredTheme();

          // Re-aplica el estado tras navegaci칩n SPA
          if (typeof window !== "undefined") {
            window.addEventListener("astro:after-swap", function () {
              setTimeout(applyStoredTheme, 0);
            });
            window.addEventListener("storage", function (e) {
              if (e.key === "theme") setTimeout(applyStoredTheme, 0);
            });
          }
        }
      }

      try {
        customElements.define("theme-toggle", ThemeToggle);
      } catch (e) {}
    }
  })();
</script>

<style>
  /* Mejora visual del bot칩n */
  theme-toggle button {
    position: relative;
  }

  /* Asegurar que las transiciones funcionen correctamente */
  theme-toggle #icon-sun,
  theme-toggle #icon-moon {
    transition:
      opacity 0.3s ease-in-out,
      transform 0.3s ease-in-out,
      color 0.3s ease-in-out;
    will-change: opacity, transform;
  }

  /* Mejora del hover effect */
  theme-toggle button:hover #icon-sun,
  theme-toggle button:hover #icon-moon {
    transform-origin: center;
  }
</style>
